harnessApiVersion: '1.0'
type: SHELL_SCRIPT
outputVars: uname
scriptString: |+
  #!/bin/bash
  pwd
  echo "testing vault"
  export VAULT_ADDR=https://kmaas.nbs-shared-security-test.aws.nbscloud.co.uk/
  export VAULT_SKIP_VERIFY=true
  export VAULT_NAMESPACE=aws/nbs-shared-cbj-dev
  export SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
  export VAULT_TOKEN=$(vault write auth/kubernetes-harness-nbs-shared-cbj-dev/login role=cicd -path=/kubernetes-harness-nbs-shared-cbj-dev jwt="$SA_TOKEN" -format="json" | /tmp/jq-linux64 -r '.auth.client_token')

  export cert="$(vault kv get -field=${vault_secret_key1} ${vault_secret_path})"
  #export uname="$(vault kv get -field=${vault_secret_key1} ${vault_secret_path})"
  #export password="$(vault kv get -field=${vault_secret_key2} ${vault_secret_path})"
  echo "certificate: $cert "
  echo "$cert" >> /opt/harness-delegate/cert.txt
  cat cert.txt

scriptType: BASH
secretOutputVars: password
timeoutMillis: 600000
variables:
- name: vault_secret_path
  value: secrets/sample-cert
- name: vault_secret_key1
  value: cert
- name: cert"
